---
title: "Practical 4"
author: "Matteo Larrode"
date: "2023-10-26"
output: html_document
---

# Week 4: Randomised Experiments: Inference and External Validity

```{r setup}
library(tidyverse)
library(randomizr)

load("data/practical4_data.Rda")
```

a) Using a simple regression, calculate the ATE and its p-value from the experiment, ignoring blocking (suppose we didn’t realise this was a block-randomised experiment). Store the ATE as an object

```{r}
summary(lm(Y ~ Z, data = a))
ate <- summary(lm(Y ~ Z, data = a))$coef[2]
```
b) Calculate the number of possible unique treatment vectors that can arise in this experiment, which has 7 treatment units and 7 control units.

_Code Hint: Use the formula for combinations with replacement in the lecture slides, together with R’s factorial() command_

```{r}
combinations <- factorial(14)/(factorial(7)*factorial(14-7))
```

c) Using the following code, create a matrix of all possible permutations of treatment assignment, ignoring the blocking (it may take 1-2 minutes to run). Verify that it gives you the correct number, as calculated in (b).

```{r}
perms <- unique(replicate(50000,complete_ra(14)),MARGIN=2)
```

d) Now, create the null distribution of ATEs using the permutations matrix:

i) Create an empty vector called “ates” using ates <- c().
```{r}
ates <- c()
```

ii) Using a for() loop, fill in this vector with the ATE under each possible permutation of treatment
```{r}
col_outcome <- a$Y
perms_df <- as.data.frame(perms)

calc_ate <- function(treatment, outcome){
  new_df <- tibble(treatment, outcome)
  ate <- summary(lm(outcome ~ treatment, data = new_df))$coef[2]
  
  return(ate)
}


for(i in colnames(as.data.frame(perms))){
  ates[i] <- calc_ate(perms_df[[i]], col_outcome)
}
```

e) Calculate the exact two-tailed p-value using 
- the estimated ATE from (a)
- the null distribution from (d), 

and give a precise interpetation of it. Is it higher or lower than the p-value calculated the traditional way in (a)?

_Hint: You need to calculate the proportion of the null distribution that is at least as extreme as the estimated ATE. It can help to start with a drawing_

```{r}


```

